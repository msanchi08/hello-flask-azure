trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  - group: var2   # <-- your Library variable group

  - name: IMAGE_NAME
    value: hello-flask
  - name: CONTAINER_NAME
    value: hello-flask
  - name: CONTAINER_PORT
    value: 5001
  - name: HOST_PORT
    value: 80
  - name: VM_USER
    value: azureuser
  - name: VM_HOST
    value: 52.157.242.191   # your VM public IP

steps:
# --------------------------------------------------
# 1. Checkout source
# --------------------------------------------------
- checkout: self

# --------------------------------------------------
# 2. Docker login (AGENT → ACR)
# --------------------------------------------------
- script: |
    echo "Logging in to ACR from pipeline agent..."
    echo "$(ACR_PASSWORD)" | docker login $(ACR_LOGIN_SERVER) \
      -u "$(ACR_USERNAME)" \
      --password-stdin
  displayName: "Docker login to ACR (agent)"

# --------------------------------------------------
# 3. Build Docker image
# --------------------------------------------------
- script: |
    docker build -t $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(Build.BuildId) .
  displayName: "Build Docker image"

# --------------------------------------------------
# 4. Push Docker image
# --------------------------------------------------
- script: |
    docker push $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(Build.BuildId)
  displayName: "Push image to ACR"

# --------------------------------------------------
# 5. Download SSH key
# --------------------------------------------------
- task: DownloadSecureFile@1
  name: sshkey
  inputs:
    secureFile: vm-flask-devops_key.pem

# --------------------------------------------------
# 6. Deploy to VM (SSH → docker pull/run)
# --------------------------------------------------
- script: |
    chmod 600 $(sshkey.secureFilePath)

    ssh -i $(sshkey.secureFilePath) \
        -o StrictHostKeyChecking=no \
        $(VM_USER)@$(VM_HOST) << EOF

      echo "Login to ACR from VM..."
      echo "$(ACR_PASSWORD)" | docker login $(ACR_LOGIN_SERVER) \
        -u "$(ACR_USERNAME)" \
        --password-stdin

      echo "Pull image..."
      docker pull $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(Build.BuildId)

      echo "Stop old container..."
      docker rm -f $(CONTAINER_NAME) || true

      echo "Run new container..."
      docker run -d \
        --name $(CONTAINER_NAME) \
        -p $(HOST_PORT):$(CONTAINER_PORT) \
        --restart unless-stopped \
        $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(Build.BuildId)

      docker ps
    EOF
  displayName: "Deploy to Azure VM (Docker run)"
